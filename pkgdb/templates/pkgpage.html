<?python
TODO='Not yet implemented'
?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml"
      xmlns:py="http://genshi.edgewall.org/"
      xmlns:xi="http://www.w3.org/2001/XInclude">
  <xi:include href="layout.html" />
  <body>
    <script type="text/javascript" src="${tg.url('/static/javascript/framework.js')}"></script>
    <script type="text/javascript" src="${tg.url('/static/javascript/pkgpage.js')}"></script>

    <h2 py:content="packageListings[0].package.name">Package</h2>
    <ul class="actions">
      <li><a class="koji" href="${'http://koji.fedoraproject.org/koji/search?type=package&amp;match=glob&amp;terms='
        + tg.quote_plus(packageListings[0].package.name)}">Koji</a></li>
      <li><a class="bodhi" href="${'https://admin.fedoraproject.org/updates/'
        + tg.quote_plus(packageListings[0].package.name)}">Bodhi</a></li>
    </ul>

    <table>
      <tr><th>
          Status
        </th>
        <td py:content="packageListings[0].package.status.translations[0].statusname">
      </td></tr>
      <tr><th>
          Creation Date
          </th><td py:content="TODO">
          Fill in the Creation Date
      </td></tr>
    </table>
    <p py:content="packageListings[0].package.summary">Summary</p>
    <p py:content="packageListings[0].package.description">Description</p>

    <p>Contents:
    <ul py:for="pkg in packageListings">
      <li><a py:attrs="{'href' : ''.join(
        ('#', pkg.collection.name, pkg.collection.version)).replace(' ','')}"
        py:content="' '.join((pkg.collection.name, pkg.collection.version))">
      </a></li>
    </ul>
    </p>

    <form action="${tg.url('/packages/dispatcher/')}" method="POST">
      <table class="pkglist" py:for="pkg in packageListings"
        py:attrs="{'name': str(pkg.id)}">
        <?python
        # Determine whether the present user is already involved with this
        # packagelisting and if they are allowed to change acls
        interested = False # Does the person already have an acl line?
        aclChanger = False # Is the person allowed to make changes?
        if tg.identity.anonymous:
            # Anonymous users can only look
            pass
        else:
            if tg.identity.user.user_id == pkg.ownerid:
                # Package owners can make changes and add themselves to acls
                aclChanger = True
            else:
                for person in pkg.people:
                    if person.userid == tg.identity.user.user_id:
                        # Person has an acl on the package
                        for acl in aclNames:
                            if person.aclOrder[acl]:
                                # At least one of those acls is not-Obsolete
                                interested = True
                                break
                        if (person.aclOrder.get('approveacls') and
                                person.aclOrder['approveacls'].status.translations[0].statusname == 'Approved'):
                            # Person has approveacls acl.
                            aclChanger = True
                        break
            if not aclChanger:
                for group in tg.identity.user.groups:
                    if group.group_name == 'cvsadmin':
                        # Person is an admin and thus can make changes
                        aclChanger = True
                        break
        ?>
        <tr><th>
            Collection
            </th><th>
            Owner
            </th><th>
            QA Contact
            </th><th>
            Status
        </th></tr>
        <tr id="${''.join((pkg.collection.name, pkg.collection.version)).replace(' ','')}">
          <td><a href="${tg.url('/collections/id/' + str(pkg.collection.id))}"
              py:content="' '.join((pkg.collection.name, pkg.collection.version))"></a>
            </td><td>
            <div py:choose="pkg.ownerid" py:strip="">
              <div py:when="9900"
                py:attrs="{'name': str(pkg.id)}"
                class="requestContainer owner orphaned">
                <span class="ownerName">${pkg.ownername}</span>
                <span py:if="'cvsextras' in tg.identity.groups and pkg.collection.status.translations[0].statusname!='EOL'">
                  <input type="button" name="unorphan"
                    class="ownerButton unorphanButton"
                    value="Take Ownership"/>
                </span>
              </div>
              <div py:otherwise=""
                py:attrs="{'name': str(pkg.id)}"
                class="requestContainer owner owned">
                <span class="ownerName"><a href="${tg.url('/users/info/' + pkg.owneruser)}">${pkg.ownername}</a></span>
                <span py:if="not tg.identity.anonymous and (tg.identity.user.user_id == pkg.ownerid or 'cvsadmin' in tg.identity.groups)">
                  <input type="button" name="orphan"
                    class="ownerButton orphanButton"
                    value="Release Ownership"/>
                </span>
              </div>
            </div>
            </td><td py:content="pkg.qacontactname">
            </td><td py:content="pkg.status.translations[0].statusname">
        </td></tr>
        <tr py:if="not tg.identity.anonymous or pkg.people" colspan="4"><td colspan="4">
            <table class="acls" width="100%">
              <tr>
                <th py:for="colName in ['User'] + list(aclNames)" py:content="colName">
                </th>
              </tr>
              <tr py:for="person in pkg.people" py:if="[acl for acl in aclNames if person.aclOrder[acl]]" class="aclrow">
                <td class="acluser"
                  py:attrs="{'name': str(pkg.id) + ':' + str(person.userid)}">
                  <a href="${tg.url('/users/info/' + person.user)}">${person.name}</a>
                </td>
                <td py:for="acl in aclNames" class="aclcell">
                  <!-- If the logged in user is this row, add a checkbox to set it -->
                  <div py:if="not tg.identity.anonymous and
                    person.userid==tg.identity.user.user_id"
                    py:attrs="{'name' : str(pkg.id) + ':' + acl}"
                    class="requestContainer aclPresent">
                    <input type="checkbox" checked="true" class="aclPresentBox"
                    py:if="person.aclOrder[acl]"/>
                    <input type="checkbox" class="aclPresentBox"
                    py:if="not person.aclOrder[acl]"/>
                  </div>
                  <!-- If the user can set acls, give drop downs for status -->
                  <div py:choose="" py:strip="">
                    <div py:when="aclChanger"
                      py:attrs="{'name': str(pkg.id) + ':' + acl}"
                      class='aclStatus requestContainer'>
                      <select class="aclStatusList" py:attrs="{'name' : acl}">
                        <option py:for="status in aclStatus" py:content="status"
                          py:attrs="{'value': status, 'name': status,
                          'selected': tg.selector(person.aclOrder.get(acl) and person.aclOrder[acl].status.translations[0].statusname==status)}"
                        />
                      </select>
                    </div>
                    <span py:otherwise="" py:choose="" class="aclStatus"
                      py:attrs="{'name' : str(pkg.id) + ':' + acl}">
                      <span py:when="person.aclOrder.get(acl)"
                      py:replace="person.aclOrder[acl].status.translations[0].statusname" />
                    </span>
                  </div>
                </td>
              </tr>
              <tr py:for="group in pkg.groups" class="aclgrouprow">
                <td py:content="group.name" class="aclgroup"
                  py:attrs="{'name': str(pkg.id) + ':' + str(group.groupid)}">
                  Name
                </td>
                <!-- If the user has permission to edit the acls, give them a
                checkbox to edit this
                -->
                <td class="groupaclcell" py:attrs="{'colspan' : str(len(aclNames))}">
                  <div py:if="aclChanger"
                    py:attrs="{'name' : str(pkg.id) + ':' + str(group.groupid) +
                    ':commit'}"
                    class="requestContainer groupAclStatus">
                    group members can commit?
                    <input type="checkbox" class="groupAclStatusBox"
                      py:attrs="{'checked': tg.checker(group.aclOrder.get('commit') and group.aclOrder['commit'].status.translations[0].statusname=='Approved')}"/>
                  </div>
                  <div py:if="not aclChanger"
                    py:attrs="{'name' : str(pkg.id) + ':' + str(group.groupid)
                    + ':commit'}"
                    class="groupAclStatus requestContainer">
                    group members can commit?
                    <input type="checkbox" class="groupAclStatusLabelBox"
                      disabled="true"
                      py:attrs="{'checked': tg.checker(group.aclOrder.get('commit') and group.aclOrder['commit'].status.translations[0].statusname=='Approved')}"/>
                  </div>
                </td>
              </tr>
              <tr py:if="not tg.identity.anonymous and not interested">
                <td class="acladd" py:attrs="{'colspan' : str(len(aclNames)+1)}">
                  <input type="button" py:attrs="{'name':'add:' + str(pkg.package.id)
                  + ':' + str(tg.identity.user.user_id)}"
                  class="addMyselfButton"
                  value="Add myself to package"/>
                </td>
              </tr>
            </table>
        </td></tr>
      </table>
    </form>
  </body>
</html>
