<?xml version="1.0" encoding="utf-8" ?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<meta name="generator" content="Docutils 0.5: http://docutils.sourceforge.net/" />
<title>Changes to DB Model</title>
<meta name="author" content="Toshio Kuratomi" />
<meta name="date" content="16 Oct, 2008" />
<style type="text/css">

/*
:Author: David Goodger (goodger@python.org)
:Id: $Id: html4css1.css 5196 2007-06-03 20:25:28Z wiemann $
:Copyright: This stylesheet has been placed in the public domain.

Default cascading style sheet for the HTML output of Docutils.

See http://docutils.sf.net/docs/howto/html-stylesheets.html for how to
customize this style sheet.
*/

/* used to remove borders from tables and images */
.borderless, table.borderless td, table.borderless th {
  border: 0 }

table.borderless td, table.borderless th {
  /* Override padding for "table.docutils td" with "! important".
     The right padding separates the table cells. */
  padding: 0 0.5em 0 0 ! important }

.first {
  /* Override more specific margin styles with "! important". */
  margin-top: 0 ! important }

.last, .with-subtitle {
  margin-bottom: 0 ! important }

.hidden {
  display: none }

a.toc-backref {
  text-decoration: none ;
  color: black }

blockquote.epigraph {
  margin: 2em 5em ; }

dl.docutils dd {
  margin-bottom: 0.5em }

/* Uncomment (and remove this text!) to get bold-faced definition list terms
dl.docutils dt {
  font-weight: bold }
*/

div.abstract {
  margin: 2em 5em }

div.abstract p.topic-title {
  font-weight: bold ;
  text-align: center }

div.admonition, div.attention, div.caution, div.danger, div.error,
div.hint, div.important, div.note, div.tip, div.warning {
  margin: 2em ;
  border: medium outset ;
  padding: 1em }

div.admonition p.admonition-title, div.hint p.admonition-title,
div.important p.admonition-title, div.note p.admonition-title,
div.tip p.admonition-title {
  font-weight: bold ;
  font-family: sans-serif }

div.attention p.admonition-title, div.caution p.admonition-title,
div.danger p.admonition-title, div.error p.admonition-title,
div.warning p.admonition-title {
  color: red ;
  font-weight: bold ;
  font-family: sans-serif }

/* Uncomment (and remove this text!) to get reduced vertical space in
   compound paragraphs.
div.compound .compound-first, div.compound .compound-middle {
  margin-bottom: 0.5em }

div.compound .compound-last, div.compound .compound-middle {
  margin-top: 0.5em }
*/

div.dedication {
  margin: 2em 5em ;
  text-align: center ;
  font-style: italic }

div.dedication p.topic-title {
  font-weight: bold ;
  font-style: normal }

div.figure {
  margin-left: 2em ;
  margin-right: 2em }

div.footer, div.header {
  clear: both;
  font-size: smaller }

div.line-block {
  display: block ;
  margin-top: 1em ;
  margin-bottom: 1em }

div.line-block div.line-block {
  margin-top: 0 ;
  margin-bottom: 0 ;
  margin-left: 1.5em }

div.sidebar {
  margin: 0 0 0.5em 1em ;
  border: medium outset ;
  padding: 1em ;
  background-color: #ffffee ;
  width: 40% ;
  float: right ;
  clear: right }

div.sidebar p.rubric {
  font-family: sans-serif ;
  font-size: medium }

div.system-messages {
  margin: 5em }

div.system-messages h1 {
  color: red }

div.system-message {
  border: medium outset ;
  padding: 1em }

div.system-message p.system-message-title {
  color: red ;
  font-weight: bold }

div.topic {
  margin: 2em }

h1.section-subtitle, h2.section-subtitle, h3.section-subtitle,
h4.section-subtitle, h5.section-subtitle, h6.section-subtitle {
  margin-top: 0.4em }

h1.title {
  text-align: center }

h2.subtitle {
  text-align: center }

hr.docutils {
  width: 75% }

img.align-left {
  clear: left }

img.align-right {
  clear: right }

ol.simple, ul.simple {
  margin-bottom: 1em }

ol.arabic {
  list-style: decimal }

ol.loweralpha {
  list-style: lower-alpha }

ol.upperalpha {
  list-style: upper-alpha }

ol.lowerroman {
  list-style: lower-roman }

ol.upperroman {
  list-style: upper-roman }

p.attribution {
  text-align: right ;
  margin-left: 50% }

p.caption {
  font-style: italic }

p.credits {
  font-style: italic ;
  font-size: smaller }

p.label {
  white-space: nowrap }

p.rubric {
  font-weight: bold ;
  font-size: larger ;
  color: maroon ;
  text-align: center }

p.sidebar-title {
  font-family: sans-serif ;
  font-weight: bold ;
  font-size: larger }

p.sidebar-subtitle {
  font-family: sans-serif ;
  font-weight: bold }

p.topic-title {
  font-weight: bold }

pre.address {
  margin-bottom: 0 ;
  margin-top: 0 ;
  font-family: serif ;
  font-size: 100% }

pre.literal-block, pre.doctest-block {
  margin-left: 2em ;
  margin-right: 2em }

span.classifier {
  font-family: sans-serif ;
  font-style: oblique }

span.classifier-delimiter {
  font-family: sans-serif ;
  font-weight: bold }

span.interpreted {
  font-family: sans-serif }

span.option {
  white-space: nowrap }

span.pre {
  white-space: pre }

span.problematic {
  color: red }

span.section-subtitle {
  /* font-size relative to parent (h1..h6 element) */
  font-size: 80% }

table.citation {
  border-left: solid 1px gray;
  margin-left: 1px }

table.docinfo {
  margin: 2em 4em }

table.docutils {
  margin-top: 0.5em ;
  margin-bottom: 0.5em }

table.footnote {
  border-left: solid 1px black;
  margin-left: 1px }

table.docutils td, table.docutils th,
table.docinfo td, table.docinfo th {
  padding-left: 0.5em ;
  padding-right: 0.5em ;
  vertical-align: top }

table.docutils th.field-name, table.docinfo th.docinfo-name {
  font-weight: bold ;
  text-align: left ;
  white-space: nowrap ;
  padding-left: 0 }

h1 tt.docutils, h2 tt.docutils, h3 tt.docutils,
h4 tt.docutils, h5 tt.docutils, h6 tt.docutils {
  font-size: 100% }

ul.auto-toc {
  list-style-type: none }

</style>
</head>
<body>
<div class="document" id="changes-to-db-model">
<h1 class="title">Changes to DB Model</h1>
<table class="docinfo" frame="void" rules="none">
<col class="docinfo-name" />
<col class="docinfo-content" />
<tbody valign="top">
<tr><th class="docinfo-name">Author:</th>
<td>Toshio Kuratomi</td></tr>
<tr><th class="docinfo-name">Date:</th>
<td>16 Oct, 2008</td></tr>
</tbody>
</table>
<p>We want to make some changes to the DB Model.  In some cases these will be
fairly invasive and require rewriting various bits of both client code and
pkgdb server code.  Client code could hopefully be incorporated into
<cite>fedora.client.pkgdb</cite> so that there's a single place to update for changes in
the server in the future.</p>
<div class="contents topic" id="contents">
<p class="topic-title first">Contents</p>
<ul class="simple">
<li><a class="reference internal" href="#remove-one-many-lists" id="id5">Remove One::Many Lists</a><ul>
<li><a class="reference internal" href="#porting" id="id6">Porting</a></li>
</ul>
</li>
<li><a class="reference internal" href="#change-user-and-group" id="id7">Change User and Group</a><ul>
<li><a class="reference internal" href="#id1" id="id8">Porting</a></li>
</ul>
</li>
<li><a class="reference internal" href="#normalize-statuscode-statuscodeid" id="id9">Normalize Statuscode/StatuscodeId</a><ul>
<li><a class="reference internal" href="#id2" id="id10">Porting</a></li>
</ul>
</li>
<li><a class="reference internal" href="#reorganize-the-model" id="id11">Reorganize the Model</a></li>
<li><a class="reference internal" href="#simpler-logging" id="id12">Simpler Logging</a><ul>
<li><a class="reference internal" href="#id3" id="id13">Porting</a></li>
</ul>
</li>
<li><a class="reference internal" href="#change-ownership-to-an-acl" id="id14">Change Ownership to an Acl</a><ul>
<li><a class="reference internal" href="#id4" id="id15">Porting</a></li>
</ul>
</li>
<li><a class="reference internal" href="#lazy-eager-loading" id="id16">Lazy/Eager Loading</a></li>
</ul>
</div>
<div class="section" id="remove-one-many-lists">
<h1><a class="toc-backref" href="#id5">Remove One::Many Lists</a></h1>
<table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field"><th class="field-name">Status:</th><td class="field-body">Design Finalizing</td>
</tr>
</tbody>
</table>
<p>The 0.3.x API was updated to take advantage of SA-0.4's dictionary collections.
We did this by adding the dictionary mappings in addition to the list of items.
So, for instance, the Package class has both <cite>Package.listings</cite> =&gt; <cite>list()</cite>
of <cite>PackageListing`s and `Package.listings2</cite> =&gt; <cite>dict()</cite> of <cite>PackageListing`s
keyed on the `Collection</cite> short name.  For the 0.4.x release we want to move
the dictionary mapping to <cite>Package.listing</cite> and remove <cite>Package.listing2</cite>.</p>
<div class="section" id="porting">
<h2><a class="toc-backref" href="#id6">Porting</a></h2>
<p>You'll need to change your code in the following ways:</p>
<ul class="simple">
<li>If your code requires a list::
- pkg_list = Package.listing
+ pkg_list = Package.listing.values()</li>
<li>If your code is using the <tt class="docutils literal"><span class="pre">listing2</span></tt> interface::
- pkg_dict = Package.listing2
+ pkg_dict = Package.listing</li>
</ul>
<p>This affects the following pairs of methods:</p>
<table border="1" class="docutils">
<colgroup>
<col width="37%" />
<col width="15%" />
<col width="15%" />
<col width="33%" />
</colgroup>
<tbody valign="top">
<tr><td>Class</td>
<td>Old Dict</td>
<td>New Dict</td>
<td>Old List (removed)</td>
</tr>
<tr><td>PersonPackageListing</td>
<td>acls2</td>
<td>acls</td>
<td>acls</td>
</tr>
<tr><td>GroupPackageListing</td>
<td>acls2</td>
<td>acls</td>
<td>acls</td>
</tr>
<tr><td>Collection</td>
<td>listing2</td>
<td>listing</td>
<td>listing</td>
</tr>
<tr><td>Package</td>
<td>listing2</td>
<td>listing</td>
<td>listing</td>
</tr>
<tr><td>PackageListing</td>
<td>people2</td>
<td>people</td>
<td>people</td>
</tr>
<tr><td>PackageListing</td>
<td>groups2</td>
<td>groups</td>
<td>groups</td>
</tr>
<tr><td>CollectionStatus</td>
<td>locale</td>
<td>locale</td>
<td>translations</td>
</tr>
<tr><td>PackageListingStatus</td>
<td>locale</td>
<td>locale</td>
<td>translations</td>
</tr>
<tr><td>PackageStatus</td>
<td>locale</td>
<td>locale</td>
<td>translations</td>
</tr>
<tr><td>PackageAclStatus</td>
<td>locale</td>
<td>locale</td>
<td>translations</td>
</tr>
</tbody>
</table>
</div>
</div>
<div class="section" id="change-user-and-group">
<h1><a class="toc-backref" href="#id7">Change User and Group</a></h1>
<table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field"><th class="field-name">Status:</th><td class="field-body">Design Finalizing</td>
</tr>
</tbody>
</table>
<p>We're going to switch from using numeric userid/groupid's to usernames and
groupnames from the Fedora Account System. This makes changing usernames
harder but it is something that's already a problem with bodhi, koji, etc.
The plus side is we don't have to lookup information in FAS just to have a
reasonable way to identify the user to the person using hte pkgdb.</p>
<p>As part of this change we will also change the following fields:</p>
<table border="1" class="docutils">
<colgroup>
<col width="52%" />
<col width="48%" />
</colgroup>
<tbody valign="top">
<tr><td>Old Column Name</td>
<td>New Column Name</td>
</tr>
<tr><td>PersonPackageListing.userid</td>
<td>PersonPackageListing.user</td>
</tr>
<tr><td>GroupPackageListing.groupid</td>
<td>GroupPackageListing.group</td>
</tr>
</tbody>
</table>
<p>In many cases, the json API added convenience attributes with the username
embedded.  These will be removed as well as they're now redundant:</p>
<table border="1" class="docutils">
<colgroup>
<col width="55%" />
<col width="45%" />
</colgroup>
<tbody valign="top">
<tr><td>Convenience Attribute</td>
<td>New Attribute</td>
</tr>
<tr><td>PackageListing.owneruser</td>
<td>PackageListing.owner</td>
</tr>
<tr><td>[Incomplete]</td>
<td>[Incomplete]</td>
</tr>
</tbody>
</table>
<div class="section" id="id1">
<h2><a class="toc-backref" href="#id8">Porting</a></h2>
<p>In order to port you'll need to change any code that expects numeric userids
to accept usernames instead.  You'll have to send back usernames instead.  For
the most part, this will simply mean removing code which did conversions as you
probably wanted to get usernames before.  Sometimes, when you wanted to retrieve
more information from FAS, it will mean you have to use a different FASmethod to
retrieve the data as you'll have a username for FAS instead of a userid.</p>
<dl class="docutils">
<dt>Here's an example of the old way to do things::</dt>
<dd>pkgdb = PackageDB()
fas = AccountSystem(username=USER, password=PASS)
pkgdata = pkgdb.send_request('/package/name/kernel')
uid = pkgdata.packageListings[0]['owner']
username = pkgdata.packageListings[0]['owneruser']
person = fas.person_by_id(uid)</dd>
<dt>Converted to the new way::</dt>
<dd>pkgdb = PackageDB()
fas = AccountSystem(username=USER, password=PASS)
pkgdata = pkgdb.send_request('/package/name/kernel')
username = pkgdata.packageListings['devel']['owner']
person = fas.person_by_username(username)
uid = person.id</dd>
</dl>
</div>
</div>
<div class="section" id="normalize-statuscode-statuscodeid">
<h1><a class="toc-backref" href="#id9">Normalize Statuscode/StatuscodeId</a></h1>
<table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field"><th class="field-name">Status:</th><td class="field-body">Design Finalizing</td>
</tr>
</tbody>
</table>
<p>Statuses are identified by a numeric id.  StatusCodeTranslation and all the
StatusCode tables call that column statuscodeid.  Everything else calls it
StatusCode.  We should standardize on StatusCode.</p>
<p>Affected tables:</p>
<ul class="simple">
<li>collectionlogstatuscode</li>
<li>collectionstatuscode</li>
<li>packageacllogstatuscode</li>
<li>packageaclstatuscode</li>
<li>packagebuildlogstatuscode</li>
<li>packagebuildstatuscode</li>
<li>packagelistinglogstatuscode</li>
<li>packagelistingstatuscode</li>
<li>packagelogstatuscode</li>
<li>packagestatuscode</li>
<li>statuscodetranslation</li>
</ul>
<div class="section" id="id2">
<h2><a class="toc-backref" href="#id10">Porting</a></h2>
<p>Change all occurences of <cite>statuscodeid</cite> into <cite>statuscode</cite>.</p>
</div>
</div>
<div class="section" id="reorganize-the-model">
<h1><a class="toc-backref" href="#id11">Reorganize the Model</a></h1>
<table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field"><th class="field-name">Status:</th><td class="field-body">Implemented 0.3.9</td>
</tr>
</tbody>
</table>
<p>Instead of having the entire model in one big file, breaking it up so separate
functionality is in separate files would be a plus for maintainability.</p>
<p>This is done in the 0.3.x branch as it does not change the external API.</p>
</div>
<div class="section" id="simpler-logging">
<h1><a class="toc-backref" href="#id12">Simpler Logging</a></h1>
<table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field"><th class="field-name">Status:</th><td class="field-body">Design</td>
</tr>
</tbody>
</table>
<p>Logging in the pkgdb is very precise right now.  This, unfortunately, also
makes it hard to work with.  You have to touch both the generic log table and
the table that logs the specific table you are working with when you want to
change something.  FAs2 has a single log table that is much more free form.
Perhaps this is the way to go.</p>
<p>If we do this, we'll need to add more timestamps to the other tables as we
currently depend on being able to ask the highly structured logs to tell us
when certain things happened.  (Note: This restriction is not in code
anywhere, it's just in the assumption that the user can search the logs for
when something happened because of the structured nature of the log table
hierarchy.)</p>
<div class="section" id="id3">
<h2><a class="toc-backref" href="#id13">Porting</a></h2>
<p>There is currently no server methods that expose the log tables so there is no
external interface to port.</p>
<p>Internally we'll have to restructure how we construct and save logs.</p>
</div>
</div>
<div class="section" id="change-ownership-to-an-acl">
<h1><a class="toc-backref" href="#id14">Change Ownership to an Acl</a></h1>
<table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field"><th class="field-name">Status:</th><td class="field-body">Design</td>
</tr>
</tbody>
</table>
<p>It might simplify code if ownership is specified as an acl in the database
instead of a special field in the <cite>PackageListing</cite>.  This is because only
bugzilla cares who is the owner versus a comaintainer (someone with
approveacls).</p>
<div class="section" id="id4">
<h2><a class="toc-backref" href="#id15">Porting</a></h2>
<p>Ownership will no longer be available directly from the <cite>PackageListing</cite>.  Most
code can be simplified to check the person's acls for either approveacls or
ownership instead of looking in both the packagelisting table and the acl
tables.  Code that interacts with bugzilla will have to be changed to
specifically find the owner acl.</p>
<p>External code that looked up the owner by simply looking in the
<cite>PackageListing</cite> will now have to traverse the acls.  However, many of those
pieces of code should really be looking at comaintainers anyway, so this makes
their code better.</p>
</div>
</div>
<div class="section" id="lazy-eager-loading">
<h1><a class="toc-backref" href="#id16">Lazy/Eager Loading</a></h1>
<p>Instead of relying on SQLAlchemy's defaults for whether to load foreign key
relationships we should look at whether we always or never pull in the related
tables.  Redefining the frequently pulled in tables to eager load[#]_ and the
seldom used tables to lazy load will be a large win.  This is settable per
query as well as when creating the mapper so there is a great deal of
flexibility here.</p>
<!-- [#]: http://www.sqlalchemy.org/docs/04/mappers.html#advdatamapping_relation_strategies -->
</div>
</div>
</body>
</html>
